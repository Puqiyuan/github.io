<!DOCTYPE html>
<html lang="cn">
<head>
<!-- 2023-08-17 Thu 17:58 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ipfrag_high_thresh参数的作用</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Cauchy(pqy7172@gmail.com)">
<link rel="stylesheet" href="../../org-manual.css" type="text/css">
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">ipfrag_high_thresh参数的作用</h1>
<p>
ipfrag_high_thresh是Linux内核网络参数之一，它用于控制IP分片的处理行为。IP分片是在网络通信过程中，由于MTU（最大传输单元）限制，数据包被分割成更小的片段以便传输。接收端需要重新组装这些分片，以恢复原始数据包。
</p>

<p>
ipfrag_high_thresh参数指定了一个阈值，当系统中正在等待重新组装的分片数量达到或超过该阈值时，系统会采取措施以避免过多的内存消耗。一旦达到这个阈值，内核将开始丢弃更多的分片，以避免过度的内存使用，同时保留已经组装好的分片。
</p>

<p>
使用命令：
</p>
<pre class="example">
sysctl net.ipv4.ipfrag_high_thresh
</pre>

<p>
可以查看当前系统这个值的配置是多少。而使用命令：
</p>
<pre class="example">
sysctl -w net.ipv4.ipfrag_high_thresh=new_value
</pre>

<p>
可以更改这个值，其实际影响的就是/proc/sys/net/ipv4/ipfrag_high_thresh文件。
</p>

<p>
下面分析下关于这块的网络内核代码。
</p>

<p>
在初始化阶段，ipv4_frags_init_net函数会设置一个long类型的high_thresh值为4 * 1024 * 1024：
</p>
<div class="org-src-container">
<pre class="src src-c">net-&gt;ipv4.frags.high_thresh = 4 * 1024 * 1024;
</pre>
</div>
<p>
所以内核里使用这个值其实是ipv4.frags.high_thresh这个量。关键是随后有如何下调用流程将这个量注册到/proc系统下，所以才能通过sysctl命令去修改。
</p>

<pre class="example">
ipv4_frags_init_net-&gt;ip4_frags_ns_ctl_register-&gt;register_net_sysctl
</pre>
</div>
<div id="postamble" class="status">
<p class="author">Author: Cauchy(pqy7172@gmail.com)</p>
<p class="date">Created: 2023-08-17 Thu 17:58</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
